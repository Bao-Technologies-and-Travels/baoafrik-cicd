/* groovylint-disable CompileStatic, DuplicateMapLiteral, DuplicateStringLiteral, LineLength, NestedBlockDepth */
pipeline {
    agent any

    environment {
        NODE_ENV = 'staging'
        SSH_KEY_ID = 'baoafrik-key'
        SSH_HOST = 'ashprincepageo@34.51.248.43'
        APP_DIR = '~/baoafrik-frontend'
        APP_NAME = 'frontend'
        REPO_URL = 'git@github.com:Bao-Technologies-and-Travels/baoafrik-frontend.git'
        BRANCH = 'staging'
        REPO = 'baoafrik-frontend'
        DOMAIN = 'staging.baoafrik.com'
        EMAIL = 'pageo.fonsah@baotechnologiesandtravels.com'
        BAOTECHNOLOGIES_DEV_TEAM = 'wendy.tembong@baotechnologiesandtravels.com,esther.eyere@baotechnologiesandtravels.com,toni.ebong@baotechnologiesandtravels.com,glory.tama@baotechnologiesandtravels.com,lionel.ngansop@baotechnologiesandtravels.com,arrey.johnson@baotechnologiesandtravels.com,beltus.tah@baotechnologiesandtravels.com,romanric.akam@baotechnologiesandtravels.com'
        SLACK_CHANNEL = '#staging-deploy-release-notes'
        GIT_PREVIOUS_COMMIT = ''
        GIT_COMMIT = ''
    }

    stages {
        stage('Setup server dependencies') {
            steps {
                echo 'Setting up server dependencies...'

                sshagent([env.SSH_KEY_ID]) {
                    // step 1: system updates
                    sh """
                    ssh -o StrictHostKeyChecking=no ${SSH_HOST} '
                    set -e
                        # Update and upgrade server packages
                        sudo apt update && sudo apt upgrade -y
                    '
                    """

                    // step 2: install Nodejs
                    sh """
                    ssh -o StrictHostKeyChecking=no ${SSH_HOST} '
                        # Install Node.js and npm if not already installed
                        curl -fsSL https://deb.nodesource.com/setup_24.x | sudo -E bash -
                        sudo apt install -y nodejs
                    '
                    """

                    // step 3: install pm2
                    sh """
                    ssh -o StrictHostKeyChecking=no ${SSH_HOST} '
                        # Install PM2 globally
                        sudo npm install -g pm2@latest
                        pm2 --version
                    '
                    """

                    // step 4: install other dependencies
                    sh """
                    ssh -o StrictHostKeyChecking=no ${SSH_HOST} '
                        # Setup PM2
                        pm2 startup systemd

                        # Install serve
                        sudo npm install -g serve

                        # Install postgres
                        sudo apt install -y postgresql postgresql-client-common -y

                        echo "System dependencies installed successfully."
                    '
                    """
                }
            }
        }

        stage('Clone frontend Repository') {
            steps {
                echo 'Cloning frontend repository...'
                sshagent([env.SSH_KEY_ID]) {
                    sh '''
                    ssh -o StrictHostKeyChecking=no ''' + SSH_HOST + ''' '
                        set -e

                        # Get current commit hash before cloning/pulling
                        CURRENT_COMMIT=$(git ls-remote ''' + REPO_URL + ''' ''' + BRANCH + ''' | cut -f1)
                        echo "Current commit: $CURRENT_COMMIT"

                        if [ ! -d ~/baoafrik-frontend ]; then
                            git clone -b ''' + BRANCH + ''' ''' + REPO_URL + ''' ~/baoafrik-frontend
                        fi

                        cd ''' + APP_DIR + '''

                        # Store previous commit for changelog
                        if [ -f .git/HEAD ]; then
                            git rev-parse HEAD > /tmp/previous_commit.txt
                        else
                            echo "" > /tmp/previous_commit.txt
                        fi

                        git fetch origin ''' + BRANCH + '''
                        git checkout ''' + BRANCH + '''
                        git reset --hard origin/''' + BRANCH + '''

                        # Store current commit for environment
                        echo "$CURRENT_COMMIT" > /tmp/current_commit.txt

                        echo "Frontend repository cloned/updated successfully."
                    '
                    '''

                    // Get previous and current commits for changelog
                    script {
                        String previousCommit = sh(
                            script: "ssh -o StrictHostKeyChecking=no ${SSH_HOST} 'cat /tmp/previous_commit.txt 2>/dev/null || echo \"\"'",
                            returnStdout: true
                        ).trim()
                        String currentCommit = sh(
                            script: "ssh -o StrictHostKeyChecking=no ${SSH_HOST} 'cat /tmp/current_commit.txt 2>/dev/null || echo \"\"'",
                            returnStdout: true
                        ).trim()
                        env.GIT_PREVIOUS_COMMIT = previousCommit
                        env.GIT_COMMIT = currentCommit
                    }
                }
            }
        }

        stage('Setup frontend Environment') {
            steps {
                withCredentials([
                    string(credentialsId: 'gcp_project_id',      variable: 'GCP_PROJECT_ID'),
                    string(credentialsId: 'gcp_client_email',    variable: 'GCP_CLIENT_EMAIL'),
                    string(credentialsId: 'gcp_private_key',     variable: 'GCP_PRIVATE_KEY'),
                    string(credentialsId: 'gcp_storage_bucket',  variable: 'GCP_STORAGE_BUCKET'),
                    string(credentialsId: 'app_encryption_key',  variable: 'APP_ENCRYPTION_KEY'),
                    string(credentialsId: 'db_encryption_key',  variable: 'DB_ENCRYPTION_KEY'),
                ]) {
                    sshagent([env.SSH_KEY_ID]) {
                        sh """
                        ssh -o StrictHostKeyChecking=no ${SSH_HOST} '
                            set -e
                            cd ${APP_DIR}

                            # Remove existing .env if any
                            rm -f .env

                            # Create .env file with actual secrets
                            cat > .env << EOF
REACT_APP_API_URL=https://${DOMAIN}/api
REACT_APP_WS_URL=wss://${DOMAIN}

GCP_PROJECT_ID="${GCP_PROJECT_ID}"
GCP_CLIENT_EMAIL="${GCP_CLIENT_EMAIL}"
GCP_PRIVATE_KEY="${GCP_PRIVATE_KEY}"
GCP_STORAGE_BUCKET="${GCP_STORAGE_BUCKET}"

STORAGE_PROFILE_PREFIX=profile-images
STORAGE_ATTACHMENTS_PREFIX=chat-attachments
STORAGE_PRODUCT_PREFIX=product-images
APP_ENCRYPTION_KEY="${APP_ENCRYPTION_KEY}"
DB_ENCRYPTION_KEY="${DB_ENCRYPTION_KEY}"
EOF

                            chmod 600 .env
                        '
                        """
                    }
                }
            }
        }

        stage('Deploy frontend ') {
            steps {
                echo 'Deploying frontend on server...'

                sshagent([env.SSH_KEY_ID]) {
                    sh """
                    ssh -o StrictHostKeyChecking=no ${SSH_HOST} '
                        echo "Starting frontend deployment..."

                        cd ${APP_DIR}
                        rm -rf node_modules package-lock.json build/

                        npm install
                        export NODE_OPTIONS=--max-old-space-size=4096
                        npm run build

                        pm2 delete ${APP_NAME} || true
                        pm2 start serve --name ${APP_NAME} -- -s build -l 3000

                        pm2 save
                        pm2 list

                        echo "Frontend deployment completed successfully."
                    '
                    """
                }
            }
        }
    }

    post {
        always {
            script {
                emailext(
                        subject: "${env.JOB_NAME} - Build #${env.BUILD_NUMBER} - ${currentBuild.currentResult}",
                        to: "${env.EMAIL}",
                        from: 'no-reply@baoafrik.com',
                        replyTo: 'no-reply@baoafrik.com',
                        body: """
                            <html>
                                <body style="font-family: Arial, sans-serif; line-height: 1.5; color: #333;">
                                    <h2 style="color: #2E86C1;">Jenkins Build Notification</h2>
                                    <p><strong>Job:</strong> ${env.JOB_NAME}</p>
                                    <p><strong>Build Number:</strong> ${env.BUILD_NUMBER}</p>
                                    <p><strong>Status:</strong> <span style="color: ${currentBuild.currentResult == 'SUCCESS' ? 'green' : 'red'};">${currentBuild.currentResult}</span></p>
                                    <p>Check the <a href="${env.BUILD_URL}">console output</a> for details.</p>
                                    <hr>
                                    <p style="font-size: 0.9em; color: #565;">This is an automated email from Jenkins. Please do not reply.</p>
                                </body>
                            </html>
                        """,
                        mimeType: 'text/html'
                    )
            }
        }

        success {
            script {
                emailext(
                subject: "${env.JOB_NAME} - ${currentBuild.currentResult}",
                to: "${env.BAOTECHNOLOGIES_DEV_TEAM}",
                from: 'no-reply@baoafrik.com',
                replyTo: 'no-reply@baoafrik.com',
                body: """
                    <html>
                        <body style="font-family: Arial, sans-serif; line-height: 1.5; color: #333;">
                            <h2 style="color: #2E86C1;">BaoAfrik Staging Notification</h2>
                            <p><strong>Job:</strong> ${env.JOB_NAME}</p>
                            <p><strong>Status:</strong> <span style="color: ${currentBuild.currentResult == 'SUCCESS' ? 'green' : 'red'};">${currentBuild.currentResult}</span></p>
                            <p>Check the <a href="${env.BUILD_URL}"> console output</a> for details and also see recent changes at <a href="${env.DOMAIN}"></a>.</p>
                            <hr>
                            <p style="font-size: 0.9em; color: #565;">This is an automated email from Jenkins. Please do not reply.</p>
                        </body>
                    </html>
                """,
                mimeType: 'text/html'
                )

                // Send Slack notification with release notes
                generateAndSendReleaseNotes()
            }
        }
    }
}

// Helper function to send Slack notifications
void sendSlackNotification(Map args) {
    String status = args.status
    String color = args.color
    String channel = args.channel
    Boolean includeReleaseNotes = args.containsKey('includeReleaseNotes') ? args.includeReleaseNotes : true
    String releaseNotesText = args.releaseNotes ?: ''

    String message = "${status}: ${env.JOB_NAME} - Build #${env.BUILD_NUMBER}\n"
    message += "Environment: ${env.NODE_ENV}\n"
    message += "Branch: ${env.BRANCH}\n"
    message += "Repository: ${env.REPO}\n"
    message += "Domain: https://${env.DOMAIN}\n"
    message += "<${env.BUILD_URL}|View Console Output>\n"

    if (includeReleaseNotes && releaseNotesText) {
        message += "\n*ðŸ“ Release Notes:*\n${releaseNotesText}"
    }

    slackSend(
        channel: channel,
        color: color,
        message: message
    )
}

// Helper function to generate and send release notes
void generateAndSendReleaseNotes() {
    try {
        String releaseNotes = ''

        echo '=== Release Notes Debug Info ==='
        echo "GIT_PREVIOUS_COMMIT: ${env.GIT_PREVIOUS_COMMIT}"
        echo "GIT_COMMIT: ${env.GIT_COMMIT}"
        echo "Previous commit exists: ${env.GIT_PREVIOUS_COMMIT != null && env.GIT_PREVIOUS_COMMIT != ''}"
        echo "Current commit exists: ${env.GIT_COMMIT != null && env.GIT_COMMIT != ''}"
        echo "Commits are different: ${env.GIT_PREVIOUS_COMMIT != env.GIT_COMMIT}"

        // If we have previous and current commits, generate changelog
        if (env.GIT_PREVIOUS_COMMIT && env.GIT_COMMIT && env.GIT_PREVIOUS_COMMIT != env.GIT_COMMIT) {
            echo '=== Attempting Git Changelog Plugin ==='
            // Try to use Git Changelog plugin if available
            try {
                step([
                    $class: 'GitChangelog',
                    from: [type: 'COMMIT', value: env.GIT_PREVIOUS_COMMIT],
                    to: [type: 'COMMIT', value: env.GIT_COMMIT],
                    format: 'PLAIN',
                    outputFile: 'changelog.txt'
                ])
                releaseNotes = readFile('changelog.txt').trim()
                sh 'rm -f changelog.txt'
                echo 'Git Changelog plugin succeeded'
            } catch (groovy.lang.GroovyRuntimeException e) {
                echo "Git Changelog plugin failed: ${e.message}"
                echo '=== Falling back to git log with commit range ==='
                // Fallback: Use git log to generate release notes from remote server
                sshagent([env.SSH_KEY_ID]) {
                    try {
                        releaseNotes = sh(
                            script: '''
                                ssh -o StrictHostKeyChecking=no ''' + SSH_HOST + ''' '
                                    cd ''' + APP_DIR + '''
                                    echo "Getting commits between ''' + env.GIT_PREVIOUS_COMMIT + ''' and ''' + env.GIT_COMMIT + '''"
                                    git log --pretty=format:"â€¢ %s (%h) - %an" ''' + env.GIT_PREVIOUS_COMMIT + '''..''' + env.GIT_COMMIT + ''' 2>/dev/null || echo ""
                                '
                            ''',
                            returnStdout: true
                        ).trim()
                        echo "SSH git log with range succeeded, got ${releaseNotes.length()} characters"
                    } catch (groovy.lang.GroovyRuntimeException ex) {
                        echo "SSH git log with range failed: ${ex.message}"
                        releaseNotes = "Failed to get commit range: ${ex.message}"
                    }
                }
            }
        } else {
            echo '=== No commit range available, using fallback ==='
            // If we can't get previous commit, get recent commits from remote server
            sshagent([env.SSH_KEY_ID]) {
                try {
                    releaseNotes = sh(
                        script: '''
                            ssh -o StrictHostKeyChecking=no ''' + SSH_HOST + ''' '
                                cd ''' + APP_DIR + '''
                                echo "Getting last 10 commits from repository"
                                git log --pretty=format:"â€¢ %s (%h) - %an" -10 2>/dev/null || echo "Unable to generate release notes"
                            '
                        ''',
                        returnStdout: true
                    ).trim()
                    echo "SSH git log fallback succeeded, got ${releaseNotes.length()} characters"
                } catch (groovy.lang.GroovyRuntimeException ex) {
                    echo "SSH git log fallback failed: ${ex.message}"
                    releaseNotes = "Failed to get recent commits: ${ex.message}"
                }
            }
        }
        if (releaseNotes.empty) {
            releaseNotes = 'No new changes detected in this deployment.'
        }

        // Truncate if too long (Slack has message length limits)
        final int maxSlackMessageLength = 1500
        if (releaseNotes.length() > maxSlackMessageLength) {
            releaseNotes = releaseNotes.substring(0, maxSlackMessageLength) + '\n... (truncated)'
        }

        // Send success Slack notification with release notes
        sendSlackNotification(
            status: 'SUCCESS',
            color: 'good',
            channel: env.SLACK_CHANNEL,
            releaseNotes: releaseNotes
        )
    } catch (groovy.lang.GroovyRuntimeException e) {
        echo "Failed to generate or send release notes: ${e.message}"
        // Still send success notification without release notes
        slackSend(
            channel: env.SLACK_CHANNEL,
            color: 'good',
            message: "SUCCESS: ${env.JOB_NAME} - Build #${env.BUILD_NUMBER}\nEnvironment: ${env.NODE_ENV}\n<${env.BUILD_URL}|View Console Output>\n\n*Note:* Release notes could not be generated."
        )
    }
}

